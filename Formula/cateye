#!/bin/zsh

# Check if running with sudo
if [[ $EUID -ne 0 ]]; then
    echo "This script must be run as root" 
    exit 1
fi

# Check if argument is provided
if [ $# -ne 2 ]; then
    echo "Usage: $0 install <package_name>"
    exit 1
fi

# Extract package name from argument
if [ "$1" != "install" ]; then
    echo "Usage: $0 install <package_name>"
    exit 1
fi

package_name=$2

# Function to download and install to system bin directory
download_and_install() {
    url=$1
    filename=$(basename "$url")
    curl -LO "$url" || { echo "Failed to download $url"; exit 1; }
    tar -xzf "$filename" || { echo "Failed to extract $filename"; exit 1; }
    # Assuming the extracted folder contains binaries to add to system bin directory
    cp -r "$package_name/bin/." /usr/local/bin/
    echo "$package_name binaries added to system bin directory"
}

# Step 2: Connect to server and retrieve pkg.json
json_url="https://dl.kamu.jp/$package_name/pkg.json"
pkg_json=$(curl -sS "$json_url") || { echo "Failed to retrieve pkg.json from $json_url"; exit 1; }

# Step 3: Download and add dependencies to system bin directory
dependencies=$(echo "$pkg_json" | jq -r '.dependencies | to_entries[] | .value')
for url in $dependencies; do
    download_and_install "$url"
done

# Step 4: Download and add main package to system bin directory
main_url=$(echo "$pkg_json" | jq -r '.url')
download_and_install "$main_url"

echo "Installation of $package_name completed successfully"
